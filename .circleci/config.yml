workflows:
  version: 2
  my-workflow:
    jobs:
      - pull-ids
      - get-cloud-key:
          requires:
            - pull-ids
version: 2
jobs:
  pull-ids:
    docker: 
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - run: 
         command: |
           echo 'export ROLE_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request GET \
           'https://cf-vault-kabu.cfapps.io/v1/auth/approle/role/aws/role-id' | jq -r '.data.role_id')' >> $BASH_ENV

           echo 'export SECRET_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request POST \
           'https://cf-vault-kabu.cfapps.io/v1/auth/approle/role/aws/secret-id' | jq -r '.data.secret_id')' >> $BASH_ENV

           source $BASH_ENV
           echo "SECRET ID is "$SECRET_ID
  get-cloud-key:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - run:
         command: |
           source $BASH_ENV
           echo "SECRET ID is "$SECRET_ID
