workflows:
  version: 2.1
  my-workflow:
    jobs:
      - pull-ids
      - get-cloud-key:
          requires:
            - pull-ids
version: 2.1
executors:
  my-executor:
    docker:
      - image: circleci/node:4.8.2
    working_directory: /tmp
jobs:
  pull-ids:
    executor: my-executor
    steps:
      - run: mkdir -p workspace
      - run: 
         command: |
           echo 'export ROLE_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request GET \
           '${VAULT_ADDR}/v1/auth/approle/role/aws/role-id' | jq -r '.data.role_id')' >> $BASH_ENV

           echo 'export SECRET_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request POST \
           '${VAULT_ADDR}/v1/auth/approle/role/aws/secret-id' | jq -r '.data.secret_id')' >> $BASH_ENV

           source $BASH_ENV
           echo "{" > workspace/ids-output.json
           echo "  \"secret_id\": $SECRET_ID" >> workspace/ids-output.json
           echo "  \"role_id\": $ROLE_ID" >> workspace/ids-output.json
           echo "}" >> workspace/ids-output.json

           cat workspace/ids-output.json
      - persist_to_workspace:
          root: workspace
          paths:
            - ids-output.json
  get-cloud-key:
    executor: my-executor
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
         command: |
           cat /tmp/workspace/ids-output.json

           curl \
            --request POST \
            --data @/tmp/workspace/ids-output.json \
            ${VAULT_ADDR}/v1/auth/approle/login | jq

           rm /tmp/workspace/ids-output.json


