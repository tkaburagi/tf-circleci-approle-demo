workflows:
  version: 2.1
  my-workflow:
    jobs:
      - pull-ids
      - get-cloud-key:
          requires:
            - pull-ids
version: 2.1
executors:
  my-executor:
    docker:
      - image: circleci/node:4.8.2
    working_directory: /tmp
jobs:
  pull-ids:
    executor: my-executor
    steps:
      - run: mkdir -p workspace
      - run: 
         command: |
           echo 'export ROLE_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request GET \
           'https://cf-vault-kabu.cfapps.io/v1/auth/approle/role/aws/role-id' | jq -r '.data.role_id')' >> $BASH_ENV

           echo 'export SECRET_ID=$(curl \
           --header "X-Vault-Token: ${VAULT_INIT_TOKEN}" \
           --request POST \
           'https://cf-vault-kabu.cfapps.io/v1/auth/approle/role/aws/secret-id' | jq -r '.data.secret_id')' >> $BASH_ENV

           source $BASH_ENV
           echo "#!/bin/sh\nSECRET_ID=$SECRET_ID\nROLE_ID=$ROLE_ID" > workspace/ids-output

           cat workspace/ids-output

      - persist_to_workspace:
          root: workspace
          paths:
            - ids-output
  get-cloud-key:
    executor: my-executor
    steps:
      - run:
         command: |
           echo "SECRET ID is "$SECRET_ID
